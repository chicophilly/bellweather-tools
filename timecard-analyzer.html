<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Designer Timecard Analyzer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap');

  :root {
    --bg: #f5f3ef;
    --surface: #ffffff;
    --surface-alt: #faf9f7;
    --border: #e2ddd5;
    --border-strong: #c9c2b7;
    --text: #2c2825;
    --text-muted: #78716c;
    --text-light: #a8a29e;
    --accent: #b45309;
    --accent-light: #fef3c7;
    --design: #1e40af;
    --design-bg: #eff6ff;
    --design-border: #bfdbfe;
    --construction: #166534;
    --construction-bg: #f0fdf4;
    --construction-border: #bbf7d0;
    --nonbillable: #78716c;
    --nonbillable-bg: #f5f5f4;
    --nonbillable-border: #d6d3d1;
    --danger: #dc2626;
    --danger-bg: #fef2f2;
    --success: #16a34a;
    --success-bg: #f0fdf4;
    --warning: #d97706;
    --warning-bg: #fffbeb;
    --radius: 6px;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
    --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.06), 0 2px 4px rgba(0,0,0,0.04);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    min-height: 100vh;
  }

  .mono { font-family: 'JetBrains Mono', monospace; }

  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 32px 24px;
  }

  header {
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--border);
  }

  header h1 {
    font-size: 22px;
    font-weight: 600;
    letter-spacing: -0.3px;
    color: var(--text);
  }

  header p {
    font-size: 14px;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .upload-zone {
    background: var(--surface);
    border: 2px dashed var(--border-strong);
    border-radius: var(--radius);
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.15s ease;
    position: relative;
  }

  .upload-zone:hover, .upload-zone.dragover {
    border-color: var(--accent);
    background: var(--accent-light);
  }

  .upload-zone input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  .upload-zone .icon { font-size: 28px; margin-bottom: 8px; }

  .upload-zone .label {
    font-size: 15px;
    font-weight: 500;
    color: var(--text);
  }

  .upload-zone .sub {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .file-loaded {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--success-bg);
    border: 1px solid #bbf7d0;
    border-radius: var(--radius);
    padding: 12px 16px;
    margin-bottom: 24px;
  }

  .file-loaded .name {
    font-weight: 500;
    font-size: 14px;
    flex: 1;
  }

  .file-loaded button {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 13px;
    padding: 4px 8px;
    border-radius: 4px;
  }

  .file-loaded button:hover { background: rgba(0,0,0,0.05); }

  .period-label {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 20px;
  }

  .period-label strong { color: var(--text); font-weight: 600; }

  /* Classification Section */
  .section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 20px;
    box-shadow: var(--shadow-sm);
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    user-select: none;
  }

  .section-header:hover { background: var(--surface-alt); }

  .section-header h2 {
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.3px;
    text-transform: uppercase;
    color: var(--text-muted);
  }

  .section-header .badge {
    font-size: 12px;
    font-weight: 500;
    background: var(--accent-light);
    color: var(--accent);
    padding: 2px 10px;
    border-radius: 10px;
  }

  .section-body { padding: 0; }

  .section-body.collapsed { display: none; }

  /* Job Classification Table */
  .job-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .job-table th {
    text-align: left;
    padding: 8px 18px;
    font-weight: 500;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-light);
    background: var(--surface-alt);
    border-bottom: 1px solid var(--border);
  }

  .job-table td {
    padding: 8px 18px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
  }

  .job-table tr:last-child td { border-bottom: none; }

  .job-table .job-code {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 500;
    color: var(--text);
  }

  .job-table .hours {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 500;
    text-align: right;
    min-width: 50px;
  }

  .btn-group {
    display: flex;
    gap: 0;
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: hidden;
  }

  .btn-group button {
    border: none;
    background: var(--surface);
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    color: var(--text-muted);
    transition: all 0.1s ease;
    border-right: 1px solid var(--border);
    font-family: 'DM Sans', sans-serif;
  }

  .btn-group button:last-child { border-right: none; }

  .btn-group button:hover { background: var(--surface-alt); }

  .btn-group button.active-design {
    background: var(--design-bg);
    color: var(--design);
    font-weight: 600;
  }

  .btn-group button.active-construction {
    background: var(--construction-bg);
    color: var(--construction);
    font-weight: 600;
  }

  .btn-group button.active-nonbillable {
    background: var(--nonbillable-bg);
    color: var(--nonbillable);
    font-weight: 600;
  }

  .auto-tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 3px;
    font-weight: 500;
  }

  .auto-tag.nonbillable {
    background: var(--nonbillable-bg);
    color: var(--nonbillable);
    border: 1px solid var(--nonbillable-border);
  }

  .auto-tag.excluded {
    background: var(--danger-bg);
    color: var(--danger);
    border: 1px solid #fecaca;
  }

  /* Results Section */
  .results-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    margin-top: 24px;
  }

  .summary-table-wrap {
    overflow-x: auto;
    padding: 0 18px 18px;
  }

  .summary-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    min-width: 700px;
  }

  .summary-table thead th {
    padding: 10px 12px;
    font-weight: 600;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    text-align: center;
    border-bottom: 2px solid var(--border-strong);
  }

  .summary-table thead th.period-header {
    background: var(--surface-alt);
    border-bottom: 1px solid var(--border);
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    letter-spacing: 0;
    text-transform: none;
  }

  .summary-table thead th.group-header {
    font-size: 10px;
    color: var(--text-light);
    padding: 6px 12px;
    border-bottom: 2px solid var(--border-strong);
  }

  .summary-table thead th.group-billable { color: var(--design); }
  .summary-table thead th.group-nonbillable { color: var(--nonbillable); }
  .summary-table thead th.group-total { color: var(--accent); }
  .summary-table thead th.group-design { color: var(--design); }
  .summary-table thead th.group-construction { color: var(--construction); }

  .summary-table thead th:first-child {
    text-align: left;
  }

  .summary-table tbody td {
    padding: 10px 12px;
    text-align: center;
    border-bottom: 1px solid var(--border);
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
  }

  .summary-table tbody td:first-child {
    text-align: left;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
  }

  .summary-table td.hrs-cell, .summary-table th.hrs-cell {
    background: #dbeafe;
  }

  .summary-table tfoot td.hrs-cell {
    background: #c7d9f0;
  }

  .summary-table tfoot td {
    padding: 10px 12px;
    text-align: center;
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 600;
    border-top: 2px solid var(--border-strong);
    background: var(--surface-alt);
  }

  .summary-table tfoot td:first-child {
    text-align: left;
    font-family: 'DM Sans', sans-serif;
  }

  /* KPI Cards */
  .kpi-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    padding: 18px;
  }

  .kpi-card {
    background: var(--surface-alt);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
  }

  .kpi-card .kpi-label {
    font-size: 12px;
    font-weight: 500;
    color: var(--text-muted);
    margin-bottom: 4px;
  }

  .kpi-card .kpi-target {
    font-size: 11px;
    color: var(--text-light);
    margin-bottom: 8px;
  }

  .kpi-card .kpi-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 28px;
    font-weight: 600;
  }

  .kpi-card .kpi-value.in-range { color: var(--success); }
  .kpi-card .kpi-value.out-range { color: var(--danger); }
  .kpi-card .kpi-value.warn-range { color: var(--warning); }

  .kpi-bar {
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    margin-top: 10px;
    overflow: hidden;
    position: relative;
  }

  .kpi-bar .fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.4s ease;
  }

  .kpi-bar .target-zone {
    position: absolute;
    top: -2px;
    height: 10px;
    border-left: 2px solid var(--text-muted);
    border-right: 2px solid var(--text-muted);
    background: rgba(0,0,0,0.06);
    border-radius: 2px;
  }

  /* Per-Designer Detail */
  .designer-detail {
    padding: 18px;
  }

  .designer-detail h3 {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }

  .detail-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
  }

  .detail-card {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px;
  }

  .detail-card .designer-name {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 8px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
  }

  .detail-row {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    padding: 3px 0;
  }

  .detail-row .label { color: var(--text-muted); }

  .detail-row .value {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 500;
    font-size: 12px;
  }

  /* Export / Copy Section */
  .actions-bar {
    display: flex;
    gap: 10px;
    padding: 14px 18px;
    border-top: 1px solid var(--border);
    background: var(--surface-alt);
    border-radius: 0 0 var(--radius) var(--radius);
  }

  .btn {
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    transition: all 0.1s ease;
  }

  .btn:hover { background: var(--surface-alt); box-shadow: var(--shadow-sm); }

  .btn-primary {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  .btn-primary:hover { background: #92400e; }

  .btn-primary:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--text);
    color: white;
    padding: 10px 18px;
    border-radius: var(--radius);
    font-size: 13px;
    font-weight: 500;
    box-shadow: var(--shadow-md);
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.25s ease;
    z-index: 100;
  }

  .toast.show {
    transform: translateY(0);
    opacity: 1;
  }

  .hidden { display: none; }

  .chevron {
    display: inline-block;
    transition: transform 0.15s ease;
    color: var(--text-light);
    font-size: 12px;
  }

  .chevron.open { transform: rotate(90deg); }

  .unclassified-warning {
    background: var(--warning-bg);
    border: 1px solid #fde68a;
    border-radius: var(--radius);
    padding: 10px 16px;
    font-size: 13px;
    color: #92400e;
    margin: 12px 18px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .ninety-section {
    padding: 18px;
    border-top: 1px solid var(--border);
  }

  .ninety-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
  }

  .ninety-header h3 {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .ninety-header .tag {
    font-size: 10px;
    background: var(--accent-light);
    color: var(--accent);
    padding: 2px 8px;
    border-radius: 3px;
    font-weight: 600;
  }

  .copy-hint {
    font-size: 11px;
    color: var(--text-light);
    margin-top: 4px;
    font-style: italic;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .detail-grid { grid-template-columns: 1fr; }
    .kpi-row { grid-template-columns: 1fr; }
    .container { padding: 16px; }
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>Designer Timecard Analyzer</h1>
    <p>Upload biweekly timecard â†’ classify jobs â†’ get DD Metrics + Ninety.io numbers</p>
  </header>

  <!-- Project Registry (always visible) -->
  <div class="section" style="margin-bottom:24px">
    <div class="section-header" onclick="toggleSection('registryBody', this)">
      <h2>Project Registry</h2>
      <span class="chevron">â–¶</span>
    </div>
    <div class="section-body collapsed" id="registryBody">
      <p style="font-size:13px;color:var(--text-muted);padding:12px 18px 0">Flip a project when a CA gets signed. New job codes from timecards are added automatically.</p>
      <div style="padding:8px 18px 4px;display:flex;gap:8px;align-items:center">
        <input type="text" id="registryFilter" placeholder="Filter projectsâ€¦" oninput="renderRegistry()" style="flex:1;padding:6px 10px;border:1px solid var(--border);border-radius:4px;font-size:13px;font-family:'DM Sans',sans-serif;outline:none">
        <div class="btn-group" style="flex-shrink:0">
          <button id="regFilterAll" class="active-design" onclick="setRegistryView('all')">All</button>
          <button id="regFilterDesign" onclick="setRegistryView('design')">Design</button>
          <button id="regFilterConst" onclick="setRegistryView('construction')">Construction</button>
        </div>
      </div>
      <table class="job-table">
        <thead>
          <tr>
            <th>Job Code</th>
            <th style="text-align:center">Status</th>
            <th style="text-align:center;width:140px">Action</th>
          </tr>
        </thead>
        <tbody id="registryTableBody"></tbody>
      </table>
      <div style="padding:10px 18px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:center">
        <input type="text" id="newJobCode" placeholder="New job code" style="padding:6px 10px;border:1px solid var(--border);border-radius:4px;font-size:13px;font-family:'DM Sans',sans-serif;width:160px;outline:none;text-transform:uppercase">
        <button class="btn" onclick="addNewJob('design')" style="font-size:12px">+ Design</button>
        <button class="btn" onclick="addNewJob('construction')" style="font-size:12px">+ Construction</button>
      </div>
    </div>
  </div>

  <!-- Upload Zone -->
  <div id="uploadArea">
    <div class="upload-zone" id="dropZone">
      <input type="file" id="fileInput" accept=".xlsx,.xls">
      <div class="icon">ðŸ“‹</div>
      <div class="label">Drop a BWC Timecards file here, or click to browse</div>
      <div class="sub">Expects the standard biweekly .xlsx with per-person sheets</div>
    </div>
  </div>

  <!-- File Loaded Indicator -->
  <div id="fileInfo" class="hidden">
    <div class="file-loaded">
      <span>ðŸ“„</span>
      <span class="name" id="fileName"></span>
      <span class="period-label" id="periodLabel"></span>
      <button onclick="resetAll()">âœ• Clear</button>
    </div>
  </div>

  <!-- Classification Section -->
  <div id="classificationSection" class="hidden">
    <div class="section">
      <div class="section-header" onclick="toggleSection('classBody', this)">
        <h2>Job Classifications <span id="unclassifiedCount" class="badge"></span></h2>
        <span class="chevron open">â–¶</span>
      </div>
      <div class="section-body" id="classBody">
        <div id="unclassifiedWarning" class="unclassified-warning hidden">
          âš  Some jobs need classification before results can be calculated.
        </div>
        <table class="job-table">
          <thead>
            <tr>
              <th>Job Code</th>
              <th>Designers</th>
              <th style="text-align:right">Total Hrs</th>
              <th style="text-align:center">Classification</th>
            </tr>
          </thead>
          <tbody id="jobTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Results Section -->
  <div id="resultsSection" class="hidden">
    <div class="results-grid">

      <!-- Summary Table -->
      <div class="section">
        <div class="section-header" onclick="toggleSection('summaryBody', this)">
          <h2>DD Metrics Summary</h2>
          <span class="chevron open">â–¶</span>
        </div>
        <div class="section-body" id="summaryBody">
          <div class="summary-table-wrap">
            <table class="summary-table" id="summaryTable"></table>
          </div>

          <!-- KPI Section for Ninety.io -->
          <div class="ninety-section">
            <div class="ninety-header">
              <h3>Ninety.io Scorecard</h3>
              <span class="tag">Copy these values</span>
            </div>
            <div class="kpi-row" id="kpiRow"></div>
          </div>

          <div class="actions-bar">
            <button class="btn btn-primary" onclick="copyHoursOnly()">Copy Hours Only</button>
            <button class="btn" onclick="copySummaryTable()">Copy Full Table</button>
            <button class="btn" onclick="copyNinetyValues()">Copy Ninety.io Values</button>
          </div>
        </div>
      </div>

      <!-- Per-Designer Breakdown -->
      <div class="section">
        <div class="section-header" onclick="toggleSection('detailBody', this)">
          <h2>Per-Designer Breakdown</h2>
          <span class="chevron open">â–¶</span>
        </div>
        <div class="section-body" id="detailBody">
          <div class="designer-detail">
            <div class="detail-grid" id="detailGrid"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const DESIGNERS = ['Sean Farrell', 'Hayley Wynne', 'Stephanie Hoffmeier'];
const SHORT_NAMES = { 'Sean Farrell': 'Sean', 'Hayley Wynne': 'Hayley', 'Stephanie Hoffmeier': 'Stephanie' };
const NON_BILLABLE_JOBS = ['BWC', 'BWC General', 'BWC GENERAL', 'General'];
const PTO_TAGS = ['6609', 'PTO', 'VACATION', 'SICK', 'HOLIDAY', 'COMP TIME'];
const STORAGE_KEY = 'bwc_job_classifications';

// Pre-seeded classifications based on CA signing status as of Feb 2026
const DEFAULT_CLASSIFICATIONS = {
  // Construction (CA signed)
  'BACCASHV': 'construction', 'BASDENJ': 'construction', 'BLACKL': 'construction',
  'BODDORFFC': 'construction', 'CAMMYJ': 'construction', 'DOTOJ': 'construction',
  'EVANST': 'construction', 'FIKET': 'construction', 'HEUERS': 'construction',
  'LAUERJ': 'construction', 'LEEPAULINOL': 'construction', 'MARMORSTEINJ': 'construction',
  'WEIDNERC': 'construction', 'APPLEGATEJ': 'construction',
  // Design (no CA yet)
  'GOLENZ': 'design', 'ODENWALDERZ': 'design', 'CURRYA': 'design',
  'ENGELD': 'design', 'LEBOWE': 'design', 'MCGANNL': 'design',
  'ORESANYAL': 'design', 'ORESANYAL ': 'design', 'SIMPSONM': 'design',
  'WEBSTERM': 'design', 'WORTMANA': 'design',
};

let classificationMap = loadClassifications();
let parsedData = null;
let periodDate = '';

function loadClassifications() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const parsed = JSON.parse(saved);
      return { ...DEFAULT_CLASSIFICATIONS, ...parsed };
    }
  } catch {}
  return { ...DEFAULT_CLASSIFICATIONS };
}

function saveClassifications() {
  try {
    // Only persist overrides (things that differ from defaults or are new)
    const overrides = {};
    for (const [k, v] of Object.entries(classificationMap)) {
      if (DEFAULT_CLASSIFICATIONS[k] !== v || !(k in DEFAULT_CLASSIFICATIONS)) {
        overrides[k] = v;
      }
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(overrides));
  } catch {}
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

function toggleSection(bodyId, header) {
  const body = document.getElementById(bodyId);
  const chevron = header.querySelector('.chevron');
  if (body.classList.contains('collapsed')) {
    body.classList.remove('collapsed');
    chevron.classList.add('open');
  } else {
    body.classList.add('collapsed');
    chevron.classList.remove('open');
  }
}

// Detect if a tag indicates PTO / non-work
function isPTO(tag) {
  if (!tag) return false;
  const upper = tag.toUpperCase();
  return PTO_TAGS.some(p => upper.includes(p));
}

// Detect if a job code is auto-classified non-billable
function isNonBillableJob(code) {
  if (!code) return false;
  const clean = code.trim().toUpperCase();
  return clean === 'BWC' || clean === 'BWC GENERAL' || clean === 'GENERAL';
}

// Parse the uploaded XLSX
function parseTimecards(workbook) {
  const data = {};

  for (const designer of DESIGNERS) {
    const ws = workbook.Sheets[designer];
    if (!ws) continue;

    const range = XLSX.utils.decode_range(ws['!ref'] || 'A1');
    const jobs = {};
    let totalHours = 0;
    let ptoHours = 0;
    let currentJob = null;
    let currentJobHours = 0;
    let minDate = null, maxDate = null;

    for (let r = range.s.r + 1; r <= range.e.r; r++) { // skip header
      const cellA = ws[XLSX.utils.encode_cell({ r, c: 0 })];
      const cellB = ws[XLSX.utils.encode_cell({ r, c: 1 })];
      const cellD = ws[XLSX.utils.encode_cell({ r, c: 3 })];
      const cellG = ws[XLSX.utils.encode_cell({ r, c: 6 })];

      const jobCode = cellB ? String(cellB.v || '').trim() : '';
      const tag = cellD ? String(cellD.v || '') : '';
      const hours = cellG ? Number(cellG.v) || 0 : 0;
      const dateVal = cellA ? cellA.v : null;

      // Track date range
      if (dateVal && (typeof dateVal === 'number' || dateVal instanceof Date)) {
        let d;
        if (typeof dateVal === 'number') {
          d = new Date((dateVal - 25569) * 86400 * 1000);
        } else if (typeof dateVal === 'string' && dateVal.match(/\d/)) {
          d = new Date(dateVal);
        } else {
          d = dateVal;
        }
        if (d && !isNaN(d.getTime())) {
          if (!minDate || d < minDate) minDate = d;
          if (!maxDate || d > maxDate) maxDate = d;
        }
      }

      // Detect if this is a PTO row
      if (isPTO(tag)) {
        ptoHours += hours;
        continue;
      }

      // If there's a job code and a date, it's a detail row
      if (jobCode && dateVal) {
        if (currentJob && currentJob !== jobCode) {
          // We've moved to a new job block
        }
        currentJob = jobCode;
        if (!jobs[jobCode]) jobs[jobCode] = 0;
        jobs[jobCode] += hours;
        totalHours += hours;
      }
      // If there's only hours in G (no job, no date), it might be a subtotal or grand total
      // We skip these since we sum from detail rows
    }

    data[designer] = { jobs, totalHours, ptoHours, minDate, maxDate };
  }

  return data;
}

// Detect the pay period date range from all designers
function detectPeriod(data) {
  let min = null, max = null;
  for (const d of Object.values(data)) {
    if (d.minDate && (!min || d.minDate < min)) min = d.minDate;
    if (d.maxDate && (!max || d.maxDate > max)) max = d.maxDate;
  }
  if (min && max) {
    const fmt = d => `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;
    return `${fmt(min)} â€“ ${fmt(max)}`;
  }
  return 'Unknown period';
}

// Get all unique job codes across designers (excluding PTO)
function getAllJobCodes(data) {
  const codes = {};
  for (const [designer, info] of Object.entries(data)) {
    for (const [code, hrs] of Object.entries(info.jobs)) {
      if (!codes[code]) codes[code] = { total: 0, designers: [] };
      codes[code].total += hrs;
      codes[code].designers.push({ name: SHORT_NAMES[designer] || designer, hours: hrs });
    }
  }
  return codes;
}

// Auto-classify known jobs
function autoClassify(code) {
  if (isNonBillableJob(code)) return 'nonbillable-auto';
  if (classificationMap[code]) return classificationMap[code];
  return null;
}

// Render the classification table
function renderClassificationTable() {
  if (!parsedData) return;

  const jobCodes = getAllJobCodes(parsedData);
  const tbody = document.getElementById('jobTableBody');
  tbody.innerHTML = '';

  let unclassified = 0;
  const sorted = Object.entries(jobCodes).sort((a, b) => a[0].localeCompare(b[0]));

  for (const [code, info] of sorted) {
    const cls = autoClassify(code);
    const isAuto = isNonBillableJob(code);

    if (!cls && !isAuto) unclassified++;

    const tr = document.createElement('tr');

    // Job code
    const tdCode = document.createElement('td');
    tdCode.className = 'job-code';
    tdCode.textContent = code;
    tr.appendChild(tdCode);

    // Designers
    const tdDesigners = document.createElement('td');
    tdDesigners.style.fontSize = '12px';
    tdDesigners.style.color = 'var(--text-muted)';
    tdDesigners.textContent = info.designers.map(d => `${d.name} (${d.hours}h)`).join(', ');
    tr.appendChild(tdDesigners);

    // Hours
    const tdHours = document.createElement('td');
    tdHours.className = 'hours';
    tdHours.textContent = info.total;
    tr.appendChild(tdHours);

    // Classification
    const tdClass = document.createElement('td');
    tdClass.style.textAlign = 'center';

    if (isAuto) {
      const tag = document.createElement('span');
      tag.className = 'auto-tag nonbillable';
      tag.textContent = 'âŠ˜ Non-billable (auto)';
      tdClass.appendChild(tag);
    } else {
      const group = document.createElement('div');
      group.className = 'btn-group';

      const btnD = document.createElement('button');
      btnD.textContent = 'Design';
      btnD.onclick = () => classify(code, 'design');
      if (cls === 'design') btnD.className = 'active-design';

      const btnC = document.createElement('button');
      btnC.textContent = 'Construction';
      btnC.onclick = () => classify(code, 'construction');
      if (cls === 'construction') btnC.className = 'active-construction';

      const btnN = document.createElement('button');
      btnN.textContent = 'Non-billable';
      btnN.onclick = () => classify(code, 'nonbillable');
      if (cls === 'nonbillable') btnN.className = 'active-nonbillable';

      group.appendChild(btnD);
      group.appendChild(btnC);
      group.appendChild(btnN);
      tdClass.appendChild(group);
    }

    tr.appendChild(tdClass);
    tbody.appendChild(tr);
  }

  // Update badge
  const badge = document.getElementById('unclassifiedCount');
  const warning = document.getElementById('unclassifiedWarning');
  if (unclassified > 0) {
    badge.textContent = `${unclassified} unclassified`;
    badge.style.display = '';
    warning.classList.remove('hidden');
  } else {
    badge.textContent = 'All classified';
    badge.style.background = 'var(--success-bg)';
    badge.style.color = 'var(--success)';
    warning.classList.add('hidden');
  }

  // If all classified, compute results
  if (unclassified === 0) {
    computeAndRenderResults();
  } else {
    document.getElementById('resultsSection').classList.add('hidden');
  }
}

function classify(code, category) {
  classificationMap[code] = category;
  saveClassifications();
  renderClassificationTable();
}

// Compute results
function computeAndRenderResults() {
  if (!parsedData) return;

  const results = {};

  for (const [designer, info] of Object.entries(parsedData)) {
    let billable = 0, nonBillable = 0, designHrs = 0, constructionHrs = 0;

    for (const [code, hrs] of Object.entries(info.jobs)) {
      const cls = isNonBillableJob(code) ? 'nonbillable' : (classificationMap[code] || 'design');

      if (cls === 'nonbillable' || cls === 'nonbillable-auto') {
        nonBillable += hrs;
      } else {
        billable += hrs;
        if (cls === 'design') {
          designHrs += hrs;
        } else if (cls === 'construction') {
          constructionHrs += hrs;
        }
      }
    }

    const total = billable + nonBillable;
    results[designer] = {
      billable, nonBillable, total, designHrs, constructionHrs,
      billablePct: total > 0 ? billable / total : 0,
      nonBillablePct: total > 0 ? nonBillable / total : 0,
      designPct: billable > 0 ? designHrs / billable : 0,
      constructionPct: billable > 0 ? constructionHrs / billable : 0,
      ptoHours: info.ptoHours
    };
  }

  renderSummaryTable(results);
  renderKPIs(results);
  renderDetailCards(results);
  document.getElementById('resultsSection').classList.remove('hidden');
}

function pct(val) { return Math.round(val * 100) + '%'; }

function renderSummaryTable(results) {
  const table = document.getElementById('summaryTable');

  // Build period string
  let periodStr = periodDate || 'Current Period';

  table.innerHTML = `
    <thead>
      <tr>
        <th rowspan="2" style="width:130px"></th>
        <th colspan="2" class="group-header group-billable" style="border-bottom:1px solid var(--border)">Billable</th>
        <th colspan="2" class="group-header group-nonbillable" style="border-bottom:1px solid var(--border)">Non-Billable</th>
        <th class="group-header group-total" style="border-bottom:1px solid var(--border)">Total</th>
        <th colspan="2" class="group-header group-design" style="border-bottom:1px solid var(--border)">Design</th>
        <th colspan="2" class="group-header group-construction" style="border-bottom:1px solid var(--border)">Construction</th>
      </tr>
      <tr>
        <th class="hrs-cell">Hrs.</th><th>%</th>
        <th class="hrs-cell">Hrs.</th><th>%</th>
        <th class="hrs-cell">Hrs.</th>
        <th class="hrs-cell">Hrs.</th><th>%</th>
        <th class="hrs-cell">Hrs.</th><th>%</th>
      </tr>
    </thead>
    <tbody id="summaryTbody"></tbody>
    <tfoot id="summaryTfoot"></tfoot>
  `;

  const tbody = document.getElementById('summaryTbody');
  let totals = { billable: 0, nonBillable: 0, total: 0, designHrs: 0, constructionHrs: 0 };

  const order = ['Stephanie Hoffmeier', 'Sean Farrell', 'Hayley Wynne'];
  for (const designer of order) {
    const r = results[designer];
    if (!r) continue;

    totals.billable += r.billable;
    totals.nonBillable += r.nonBillable;
    totals.total += r.total;
    totals.designHrs += r.designHrs;
    totals.constructionHrs += r.constructionHrs;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${SHORT_NAMES[designer]}</td>
      <td class="hrs-cell">${r.billable}</td><td>${pct(r.billablePct)}</td>
      <td class="hrs-cell">${r.nonBillable}</td><td>${pct(r.nonBillablePct)}</td>
      <td class="hrs-cell" style="font-weight:600">${r.total}</td>
      <td class="hrs-cell">${r.designHrs}</td><td>${pct(r.designPct)}</td>
      <td class="hrs-cell">${r.constructionHrs}</td><td>${pct(r.constructionPct)}</td>
    `;
    tbody.appendChild(tr);
  }

  const tfoot = document.getElementById('summaryTfoot');
  const tfBillPct = totals.total > 0 ? totals.billable / totals.total : 0;
  const tfNonPct = totals.total > 0 ? totals.nonBillable / totals.total : 0;
  const tfDesPct = totals.billable > 0 ? totals.designHrs / totals.billable : 0;
  const tfConPct = totals.billable > 0 ? totals.constructionHrs / totals.billable : 0;

  tfoot.innerHTML = `
    <tr>
      <td>Total</td>
      <td class="hrs-cell">${totals.billable}</td><td>${pct(tfBillPct)}</td>
      <td class="hrs-cell">${totals.nonBillable}</td><td>${pct(tfNonPct)}</td>
      <td class="hrs-cell" style="font-weight:700">${totals.total}</td>
      <td class="hrs-cell">${totals.designHrs}</td><td>${pct(tfDesPct)}</td>
      <td class="hrs-cell">${totals.constructionHrs}</td><td>${pct(tfConPct)}</td>
    </tr>
  `;
}

function renderKPIs(results) {
  let totalBillable = 0, totalHours = 0, totalConstruction = 0, totalBillableForConst = 0;

  for (const r of Object.values(results)) {
    totalBillable += r.billable;
    totalHours += r.total;
    totalConstruction += r.constructionHrs;
    totalBillableForConst += r.billable;
  }

  const billablePct = totalHours > 0 ? (totalBillable / totalHours) * 100 : 0;
  const constructionPct = totalBillableForConst > 0 ? (totalConstruction / totalBillableForConst) * 100 : 0;

  const row = document.getElementById('kpiRow');

  // Billable Hours KPI
  let billableClass = 'out-range';
  if (billablePct >= 75 && billablePct <= 85) billableClass = 'in-range';
  else if (billablePct > 85) billableClass = 'warn-range';

  // Construction KPI
  let constClass = constructionPct <= 15 ? 'in-range' : 'out-range';

  row.innerHTML = `
    <div class="kpi-card">
      <div class="kpi-label">Billable Hours</div>
      <div class="kpi-target">Target: â‰¥ 75% and â‰¤ 85%</div>
      <div class="kpi-value ${billableClass}">${Math.round(billablePct)}%</div>
      <div class="kpi-bar">
        <div class="target-zone" style="left:75%;width:10%"></div>
        <div class="fill" style="width:${Math.min(billablePct, 100)}%;background:${billableClass === 'in-range' ? 'var(--success)' : billableClass === 'warn-range' ? 'var(--warning)' : 'var(--danger)'}"></div>
      </div>
      <div class="copy-hint">â†’ Enter ${Math.round(billablePct)}% into Ninety.io "Billable hours"</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Designer Billable Time in Construction</div>
      <div class="kpi-target">Target: â‰¤ 15%</div>
      <div class="kpi-value ${constClass}">${Math.round(constructionPct)}%</div>
      <div class="kpi-bar">
        <div class="target-zone" style="left:0%;width:15%"></div>
        <div class="fill" style="width:${Math.min(constructionPct, 100)}%;background:${constClass === 'in-range' ? 'var(--success)' : 'var(--danger)'}"></div>
      </div>
      <div class="copy-hint">â†’ Enter ${Math.round(constructionPct)}% into Ninety.io "Designer billable time in construction"</div>
    </div>
  `;
}

function renderDetailCards(results) {
  const grid = document.getElementById('detailGrid');
  grid.innerHTML = '';

  const order = ['Stephanie Hoffmeier', 'Sean Farrell', 'Hayley Wynne'];
  for (const designer of order) {
    const r = results[designer];
    if (!r) continue;
    const info = parsedData[designer];

    const card = document.createElement('div');
    card.className = 'detail-card';

    let jobBreakdown = '';
    const sorted = Object.entries(info.jobs).sort((a, b) => b[1] - a[1]);
    for (const [code, hrs] of sorted) {
      const cls = isNonBillableJob(code) ? 'nonbillable' : (classificationMap[code] || '');
      const clsLabel = cls === 'design' ? 'ðŸ”µ' : cls === 'construction' ? 'ðŸŸ¢' : 'âŠ˜';
      jobBreakdown += `
        <div class="detail-row">
          <span class="label">${clsLabel} ${code}</span>
          <span class="value">${hrs}h</span>
        </div>`;
    }

    if (r.ptoHours > 0) {
      jobBreakdown += `
        <div class="detail-row" style="opacity:0.5">
          <span class="label">ðŸ”´ PTO</span>
          <span class="value">${r.ptoHours}h</span>
        </div>`;
    }

    card.innerHTML = `
      <div class="designer-name">${SHORT_NAMES[designer]}</div>
      <div class="detail-row"><span class="label">Billable</span><span class="value">${r.billable}h (${pct(r.billablePct)})</span></div>
      <div class="detail-row"><span class="label">Non-billable</span><span class="value">${r.nonBillable}h (${pct(r.nonBillablePct)})</span></div>
      <div class="detail-row" style="font-weight:600;border-bottom:1px solid var(--border);padding-bottom:6px;margin-bottom:6px"><span class="label">Total</span><span class="value">${r.total}h</span></div>
      <div class="detail-row"><span class="label">â†³ Design</span><span class="value">${r.designHrs}h (${pct(r.designPct)})</span></div>
      <div class="detail-row" style="border-bottom:1px solid var(--border);padding-bottom:6px;margin-bottom:6px"><span class="label">â†³ Construction</span><span class="value">${r.constructionHrs}h (${pct(r.constructionPct)})</span></div>
      ${jobBreakdown}
    `;

    grid.appendChild(card);
  }
}

// Copy functions
function copyToClipboard(text) {
  // Try modern API first, fall back to textarea trick
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(
      () => {},
      () => fallbackCopy(text)
    );
  } else {
    fallbackCopy(text);
  }
}

function fallbackCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.left = '-9999px';
  ta.style.top = '-9999px';
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  try { document.execCommand('copy'); } catch {}
  document.body.removeChild(ta);
}

function copyHoursOnly() {
  // Copy just the hours values in a grid that maps to the blue cells
  // Layout: Name | Billable Hrs | NonBillable Hrs | Total Hrs | Design Hrs | Construction Hrs
  const results = computeResults();
  const order = ['Stephanie Hoffmeier', 'Sean Farrell', 'Hayley Wynne'];
  let totals = { billable: 0, nonBillable: 0, total: 0, designHrs: 0, constructionHrs: 0 };

  let tsv = '\tBillable\tNonBillable\tTotal\tDesign\tConstruction\n';
  for (const d of order) {
    const r = results[d];
    if (!r) continue;
    totals.billable += r.billable;
    totals.nonBillable += r.nonBillable;
    totals.total += r.total;
    totals.designHrs += r.designHrs;
    totals.constructionHrs += r.constructionHrs;
    tsv += `${SHORT_NAMES[d]}\t${r.billable}\t${r.nonBillable}\t${r.total}\t${r.designHrs}\t${r.constructionHrs}\n`;
  }
  tsv += `Total\t${totals.billable}\t${totals.nonBillable}\t${totals.total}\t${totals.designHrs}\t${totals.constructionHrs}\n`;

  copyToClipboard(tsv);
  showToast('Hours copied â€” paste into your spreadsheet (the formulas will calculate %)');
}

function copySummaryTable() {
  const results = computeResults();
  const order = ['Stephanie Hoffmeier', 'Sean Farrell', 'Hayley Wynne'];
  let totals = { billable: 0, nonBillable: 0, total: 0, designHrs: 0, constructionHrs: 0 };

  let tsv = '\tBillable Hrs\tBillable %\tNonBillable Hrs\tNonBillable %\tTotal Hrs\tDesign Hrs\tDesign %\tConstruction Hrs\tConstruction %\n';
  for (const d of order) {
    const r = results[d];
    if (!r) continue;
    totals.billable += r.billable;
    totals.nonBillable += r.nonBillable;
    totals.total += r.total;
    totals.designHrs += r.designHrs;
    totals.constructionHrs += r.constructionHrs;
    const bp = r.total > 0 ? Math.round(r.billable/r.total*100) : 0;
    const nbp = r.total > 0 ? Math.round(r.nonBillable/r.total*100) : 0;
    const dp = r.billable > 0 ? Math.round(r.designHrs/r.billable*100) : 0;
    const cp = r.billable > 0 ? Math.round(r.constructionHrs/r.billable*100) : 0;
    tsv += `${SHORT_NAMES[d]}\t${r.billable}\t${bp}%\t${r.nonBillable}\t${nbp}%\t${r.total}\t${r.designHrs}\t${dp}%\t${r.constructionHrs}\t${cp}%\n`;
  }
  const tbp = totals.total > 0 ? Math.round(totals.billable/totals.total*100) : 0;
  const tnbp = totals.total > 0 ? Math.round(totals.nonBillable/totals.total*100) : 0;
  const tdp = totals.billable > 0 ? Math.round(totals.designHrs/totals.billable*100) : 0;
  const tcp = totals.billable > 0 ? Math.round(totals.constructionHrs/totals.billable*100) : 0;
  tsv += `Total\t${totals.billable}\t${tbp}%\t${totals.nonBillable}\t${tnbp}%\t${totals.total}\t${totals.designHrs}\t${tdp}%\t${totals.constructionHrs}\t${tcp}%\n`;

  copyToClipboard(tsv);
  showToast('Full table copied');
}

function copyNinetyValues() {
  let totalBillable = 0, totalHours = 0, totalConstruction = 0, totalBillableHrs = 0;
  for (const r of Object.values(computeResults())) {
    totalBillable += r.billable;
    totalHours += r.total;
    totalConstruction += r.constructionHrs;
    totalBillableHrs += r.billable;
  }
  const bp = totalHours > 0 ? Math.round((totalBillable / totalHours) * 100) : 0;
  const cp = totalBillableHrs > 0 ? Math.round((totalConstruction / totalBillableHrs) * 100) : 0;
  const text = `Billable hours: ${bp}%\nDesigner billable time in construction: ${cp}%`;
  copyToClipboard(text);
  showToast('Ninety.io values copied');
}

function computeResults() {
  const results = {};
  for (const [designer, info] of Object.entries(parsedData)) {
    let billable = 0, nonBillable = 0, designHrs = 0, constructionHrs = 0;
    for (const [code, hrs] of Object.entries(info.jobs)) {
      const cls = isNonBillableJob(code) ? 'nonbillable' : (classificationMap[code] || 'design');
      if (cls === 'nonbillable' || cls === 'nonbillable-auto') {
        nonBillable += hrs;
      } else {
        billable += hrs;
        if (cls === 'design') designHrs += hrs;
        else constructionHrs += hrs;
      }
    }
    results[designer] = { billable, nonBillable, total: billable + nonBillable, designHrs, constructionHrs };
  }
  return results;
}

function copyAllAsText() {
  const results = computeResults();
  let text = `Designer Timecard Analysis â€” ${periodDate}\n${'â”€'.repeat(50)}\n\n`;

  const order = ['Stephanie Hoffmeier', 'Sean Farrell', 'Hayley Wynne'];
  let totals = { billable: 0, nonBillable: 0, total: 0, designHrs: 0, constructionHrs: 0 };

  for (const d of order) {
    const r = results[d];
    if (!r) continue;
    totals.billable += r.billable;
    totals.nonBillable += r.nonBillable;
    totals.total += r.total;
    totals.designHrs += r.designHrs;
    totals.constructionHrs += r.constructionHrs;

    const bp = r.total > 0 ? Math.round(r.billable/r.total*100) : 0;
    const dp = r.billable > 0 ? Math.round(r.designHrs/r.billable*100) : 0;
    const cp = r.billable > 0 ? Math.round(r.constructionHrs/r.billable*100) : 0;

    text += `${SHORT_NAMES[d]}: ${r.total}h total | ${r.billable}h billable (${bp}%) | Design ${r.designHrs}h (${dp}%) | Construction ${r.constructionHrs}h (${cp}%)\n`;
  }

  const tbp = totals.total > 0 ? Math.round(totals.billable/totals.total*100) : 0;
  const tdp = totals.billable > 0 ? Math.round(totals.designHrs/totals.billable*100) : 0;
  const tcp = totals.billable > 0 ? Math.round(totals.constructionHrs/totals.billable*100) : 0;

  text += `\nTotal: ${totals.total}h | Billable ${totals.billable}h (${tbp}%) | Design ${totals.designHrs}h (${tdp}%) | Construction ${totals.constructionHrs}h (${tcp}%)\n`;
  text += `\nâ”€â”€ Ninety.io â”€â”€\nBillable hours: ${tbp}%\nDesigner billable time in construction: ${tcp}%\n`;

  copyToClipboard(text);
  showToast('Full analysis copied to clipboard');
}

// --- Project Registry ---
let registryView = 'all';

function setRegistryView(view) {
  registryView = view;
  document.getElementById('regFilterAll').className = view === 'all' ? 'active-design' : '';
  document.getElementById('regFilterDesign').className = view === 'design' ? 'active-design' : '';
  document.getElementById('regFilterConst').className = view === 'construction' ? 'active-construction' : '';
  renderRegistry();
}

function renderRegistry() {
  const tbody = document.getElementById('registryTableBody');
  tbody.innerHTML = '';
  const filter = (document.getElementById('registryFilter').value || '').toUpperCase();

  // Collect all known project codes (non-billable excluded)
  const codes = {};
  for (const [k, v] of Object.entries(classificationMap)) {
    if (!isNonBillableJob(k)) codes[k.trim()] = v;
  }
  for (const [k, v] of Object.entries(DEFAULT_CLASSIFICATIONS)) {
    if (!isNonBillableJob(k) && !codes[k.trim()]) codes[k.trim()] = classificationMap[k.trim()] || v;
  }

  const sorted = Object.entries(codes).sort((a, b) => a[0].localeCompare(b[0]));

  for (const [code, cls] of sorted) {
    if (filter && !code.toUpperCase().includes(filter)) continue;
    if (registryView !== 'all' && cls !== registryView) continue;

    const isDefault = DEFAULT_CLASSIFICATIONS[code] === cls;
    const tr = document.createElement('tr');

    const tdCode = document.createElement('td');
    tdCode.className = 'job-code';
    tdCode.textContent = code;
    tr.appendChild(tdCode);

    const tdStatus = document.createElement('td');
    tdStatus.style.textAlign = 'center';
    const tag = document.createElement('span');
    tag.className = 'auto-tag';
    if (cls === 'design') {
      tag.style.background = 'var(--design-bg)';
      tag.style.color = 'var(--design)';
      tag.style.border = '1px solid var(--design-border)';
      tag.textContent = 'Design';
    } else if (cls === 'construction') {
      tag.style.background = 'var(--construction-bg)';
      tag.style.color = 'var(--construction)';
      tag.style.border = '1px solid var(--construction-border)';
      tag.textContent = 'Construction';
    } else {
      tag.className = 'auto-tag nonbillable';
      tag.textContent = cls;
    }
    tdStatus.appendChild(tag);
    tr.appendChild(tdStatus);

    const tdAction = document.createElement('td');
    tdAction.style.textAlign = 'center';
    if (cls === 'design') {
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.style.fontSize = '11px';
      btn.style.padding = '3px 10px';
      btn.textContent = 'CA Signed â†’';
      btn.title = 'Move to Construction';
      btn.onclick = () => {
        classificationMap[code] = 'construction';
        saveClassifications();
        renderRegistry();
        if (parsedData) renderClassificationTable();
        showToast(`${code} â†’ Construction`);
      };
      tdAction.appendChild(btn);
    } else if (cls === 'construction') {
      const btn = document.createElement('button');
      btn.style.fontSize = '11px';
      btn.style.padding = '3px 10px';
      btn.style.background = 'none';
      btn.style.border = '1px solid var(--border)';
      btn.style.borderRadius = '4px';
      btn.style.cursor = 'pointer';
      btn.style.color = 'var(--text-light)';
      btn.textContent = 'â† Back to Design';
      btn.title = 'Revert to Design (if CA was entered in error)';
      btn.onclick = () => {
        classificationMap[code] = 'design';
        saveClassifications();
        renderRegistry();
        if (parsedData) renderClassificationTable();
        showToast(`${code} â† Design`);
      };
      tdAction.appendChild(btn);
    }
    tr.appendChild(tdAction);

    tbody.appendChild(tr);
  }

  if (tbody.children.length === 0) {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 3;
    td.style.textAlign = 'center';
    td.style.padding = '16px';
    td.style.color = 'var(--text-light)';
    td.style.fontSize = '13px';
    td.textContent = 'No projects match the filter.';
    tr.appendChild(td);
    tbody.appendChild(tr);
  }
}

function addNewJob(cls) {
  const input = document.getElementById('newJobCode');
  const code = input.value.trim().toUpperCase();
  if (!code) return;
  if (isNonBillableJob(code)) {
    showToast(`${code} is auto-classified as non-billable`);
    return;
  }
  classificationMap[code] = cls;
  saveClassifications();
  input.value = '';
  renderRegistry();
  if (parsedData) renderClassificationTable();
  showToast(`Added ${code} as ${cls}`);
}

// Render registry on load
renderRegistry();

// --- File handling ---
function handleFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, { type: 'array', cellDates: false });

      // Verify designer sheets exist
      const found = DESIGNERS.filter(d => wb.SheetNames.includes(d));
      if (found.length === 0) {
        alert('Could not find any designer sheets (Sean Farrell, Hayley Wynne, Stephanie Hoffmeier) in this workbook.');
        return;
      }

      parsedData = parseTimecards(wb);
      periodDate = detectPeriod(parsedData);

      // Update UI
      document.getElementById('uploadArea').classList.add('hidden');
      document.getElementById('fileInfo').classList.remove('hidden');
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('periodLabel').innerHTML = `<strong>${periodDate}</strong>`;
      document.getElementById('classificationSection').classList.remove('hidden');

      renderClassificationTable();
    } catch (err) {
      alert('Error reading file: ' + err.message);
      console.error(err);
    }
  };
  reader.readAsArrayBuffer(file);
}

function resetAll() {
  parsedData = null;
  periodDate = '';
  document.getElementById('uploadArea').classList.remove('hidden');
  document.getElementById('fileInfo').classList.add('hidden');
  document.getElementById('classificationSection').classList.add('hidden');
  document.getElementById('resultsSection').classList.add('hidden');
  document.getElementById('fileInput').value = '';
}

// Event listeners
document.getElementById('fileInput').addEventListener('change', function(e) {
  handleFile(e.target.files[0]);
});

const dropZone = document.getElementById('dropZone');
dropZone.addEventListener('dragover', function(e) {
  e.preventDefault();
  dropZone.classList.add('dragover');
});
dropZone.addEventListener('dragleave', function() {
  dropZone.classList.remove('dragover');
});
dropZone.addEventListener('drop', function(e) {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  handleFile(e.dataTransfer.files[0]);
});
</script>

</body>
</html>
